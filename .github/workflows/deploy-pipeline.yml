name: Deploy ChillCareer Backend

on:
  push:
    branches:
      - dev
      - main

permissions:
  id-token: write
  contents: read

jobs:
  # ── Phase 0: Detect which functions changed ────────────────────────────────
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      primary:       ${{ steps.detect.outputs.primary }}
      secondary:     ${{ steps.detect.outputs.secondary }}
      has_primary:   ${{ steps.detect.outputs.has_primary }}
      has_secondary: ${{ steps.detect.outputs.has_secondary }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Detect changed functions
        id: detect
        run: |
          # Get changed function directories (HEAD~1 → HEAD).
          # Falls back to empty-tree SHA on first-ever commit.
          PREV=$(git rev-parse HEAD~1 2>/dev/null || echo "4b825dc642cb6eb9a060e54bf8d69288fbee4904")
          CHANGED=$(git diff --name-only "$PREV" HEAD \
            | grep '^src/functions/' \
            | awk -F/ '{print $3}' \
            | sort -u)
          echo "Changed function dirs:"
          echo "$CHANGED"

          # PRIMARY = creates a new API Gateway resource (root or child)
          ALL_PRIMARY=(
            "cc-auth-send-otp"
            "cc-user-create"
            "cc-user-get-profile"
            "cc-pretest-submit"
            "cc-questions-get"
            "cc-test-submit"
            "cc-payment-create-order"
            "cc-report-generate"
            "cc-ai-chat-message"
            "cc-notifications-send"
          )

          # SECONDARY = attaches a method to an existing resource
          ALL_SECONDARY=(
            "cc-auth-verify-otp"
            "cc-auth-google"
            "cc-user-update-profile"
            "cc-payment-verify"
            "cc-report-get"
          )

          build_json() {
            local arr=("$@")
            local json="["
            local first=true
            for fn in "${arr[@]}"; do
              if echo "$CHANGED" | grep -qFx "$fn"; then
                [ "$first" = true ] && first=false || json="$json,"
                json="$json\"$fn\""
              fi
            done
            echo "${json}]"
          }

          PRIMARY=$(build_json "${ALL_PRIMARY[@]}")
          SECONDARY=$(build_json "${ALL_SECONDARY[@]}")

          echo "primary=$PRIMARY"
          echo "secondary=$SECONDARY"

          echo "primary=$PRIMARY"     >> "$GITHUB_OUTPUT"
          echo "secondary=$SECONDARY" >> "$GITHUB_OUTPUT"
          [ "$PRIMARY"   != "[]" ] && echo "has_primary=true"   >> "$GITHUB_OUTPUT" || echo "has_primary=false"   >> "$GITHUB_OUTPUT"
          [ "$SECONDARY" != "[]" ] && echo "has_secondary=true" >> "$GITHUB_OUTPUT" || echo "has_secondary=false" >> "$GITHUB_OUTPUT"

  # ── Phase 1: Primary functions (create API Gateway resources) ──────────────
  deploy-primary:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.has_primary == 'true' }}
    strategy:
      max-parallel: 10
      matrix:
        function: ${{ fromJson(needs.detect-changes.outputs.primary) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::134375574022:role/GitHubActionsDeploymentRole-chillcareer
          role-session-name: GitHubActionsSession
          aws-region: ${{ github.ref == 'refs/heads/main' && 'ap-south-1' || 'eu-west-1' }}

      - name: Set AWS CLI retry configuration
        run: |
          aws configure set retry_mode adaptive
          aws configure set max_attempts 5

      - name: Install dependencies
        run: |
          cd src/functions/${{ matrix.function }}
          npm install --production

      - name: Zip Lambda function code
        run: |
          cd src/functions/${{ matrix.function }}
          zip -r function.zip . -x "*.yml"

      - name: Upload Lambda to S3
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            BUCKET="chillcareer-zips-ap-south-1"
            REGION="ap-south-1"
          else
            BUCKET="chillcareer-zips-eu-west-1"
            REGION="eu-west-1"
          fi
          aws s3 cp src/functions/${{ matrix.function }}/function.zip \
            s3://$BUCKET/${{ matrix.function }}/function.zip \
            --region $REGION

      - name: Set function-specific extra params
        run: |
          if [ "${{ matrix.function }}" == "cc-report-generate" ]; then
            echo "EXTRA_PRIMARY_PARAMS=AnthropicApiKey=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_ENV
          elif [ "${{ matrix.function }}" == "cc-ai-chat-message" ]; then
            echo "EXTRA_PRIMARY_PARAMS=AnthropicApiKey=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_ENV
          elif [ "${{ matrix.function }}" == "cc-auth-send-otp" ]; then
            echo "EXTRA_PRIMARY_PARAMS=JwtSecret=${{ secrets.JWT_SECRET }}" >> $GITHUB_ENV
          else
            echo "EXTRA_PRIMARY_PARAMS=" >> $GITHUB_ENV
          fi

      - name: Clear failed CloudFormation stack
        run: |
          STACK="cc-${{ matrix.function }}-stack"
          REGION=${{ github.ref == 'refs/heads/main' && 'ap-south-1' || 'eu-west-1' }}
          STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK" \
            --region "$REGION" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")
          echo "Stack status: $STATUS"
          if [ "$STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STATUS" = "CREATE_FAILED" ] || [ "$STATUS" = "ROLLBACK_FAILED" ]; then
            echo "Deleting stuck stack $STACK..."
            aws cloudformation delete-stack --stack-name "$STACK" --region "$REGION"
            aws cloudformation wait stack-delete-complete --stack-name "$STACK" --region "$REGION"
            echo "Stack deleted. Proceeding with fresh deploy."
          fi

      - name: Deploy CloudFormation stack
        run: |
          attempt=0
          max_attempts=3
          delay=15
          until [ "$attempt" -ge "$max_attempts" ]
          do
            echo "Attempt $((attempt+1))..."
            aws cloudformation deploy \
              --template-file src/functions/${{ matrix.function }}/cloudformation/lambda-setup.yml \
              --stack-name cc-${{ matrix.function }}-stack \
              --parameter-overrides \
                StageName=${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }} \
                Env=${{ github.ref == 'refs/heads/main' && 'Production' || 'Development' }} \
                ApiGatewayRestApiId=${{ github.ref == 'refs/heads/main' && 'PROD_API_ID' || 'ykq0pkeh54' }} \
                ApiGatewayRootResourceId=${{ github.ref == 'refs/heads/main' && 'PROD_ROOT_RESOURCE_ID' || 'zxmxqud0of' }} \
                BucketName=${{ github.ref == 'refs/heads/main' && 'chillcareer-zips-ap-south-1' || 'chillcareer-zips-eu-west-1' }} \
                DynamoDBTableSuffix=${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }} \
                $EXTRA_PRIMARY_PARAMS \
              --capabilities CAPABILITY_NAMED_IAM && break
            attempt=$((attempt+1))
            echo "Retrying in ${delay}s..."
            sleep $delay
            delay=$((delay * 2))
          done
          if [ "$attempt" -eq "$max_attempts" ]; then
            echo "Deployment failed."
            exit 1
          fi

      - name: Wait for resources
        run: sleep 30

      - name: Update Lambda code
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            BUCKET="chillcareer-zips-ap-south-1"
            REGION="ap-south-1"
          else
            BUCKET="chillcareer-zips-eu-west-1"
            REGION="eu-west-1"
          fi
          aws lambda update-function-code \
            --function-name ${{ matrix.function }}-${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }} \
            --s3-bucket $BUCKET \
            --s3-key ${{ matrix.function }}/function.zip \
            --region $REGION

  # ── Phase 2: Secondary functions (use existing API GW resources) ───────────
  deploy-secondary:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-primary]
    if: |
      always() &&
      needs.detect-changes.outputs.has_secondary == 'true' &&
      (needs.deploy-primary.result == 'success' || needs.deploy-primary.result == 'skipped')
    strategy:
      max-parallel: 4
      matrix:
        function: ${{ fromJson(needs.detect-changes.outputs.secondary) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::134375574022:role/GitHubActionsDeploymentRole-chillcareer
          role-session-name: GitHubActionsSession
          aws-region: ${{ github.ref == 'refs/heads/main' && 'ap-south-1' || 'eu-west-1' }}

      - name: Set AWS CLI retry configuration
        run: |
          aws configure set retry_mode adaptive
          aws configure set max_attempts 5

      - name: Install dependencies
        run: |
          cd src/functions/${{ matrix.function }}
          npm install --production

      - name: Zip Lambda function code
        run: |
          cd src/functions/${{ matrix.function }}
          zip -r function.zip . -x "*.yml"

      - name: Upload Lambda to S3
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            BUCKET="chillcareer-zips-ap-south-1"
            REGION="ap-south-1"
          else
            BUCKET="chillcareer-zips-eu-west-1"
            REGION="eu-west-1"
          fi
          aws s3 cp src/functions/${{ matrix.function }}/function.zip \
            s3://$BUCKET/${{ matrix.function }}/function.zip \
            --region $REGION

      - name: Fetch extra CloudFormation params
        run: |
          REGION=${{ github.ref == 'refs/heads/main' && 'ap-south-1' || 'eu-west-1' }}
          API_ID=${{ github.ref == 'refs/heads/main' && 'PROD_API_ID' || 'ykq0pkeh54' }}
          FN="${{ matrix.function }}"

          # Random jitter (1–15s) to stagger concurrent GetResources calls
          sleep $((RANDOM % 15 + 1))

          # Retry wrapper for GetResources (handles TooManyRequestsException)
          fetch_resource_id() {
            local query="$1"
            local attempt=0
            local max=5
            local delay=10
            until [ "$attempt" -ge "$max" ]; do
              ID=$(aws apigateway get-resources \
                --rest-api-id "$API_ID" \
                --region "$REGION" \
                --query "$query" \
                --output text 2>&1)
              EXIT=$?
              if [ $EXIT -eq 0 ] && [ -n "$ID" ] && [ "$ID" != "None" ]; then
                echo "$ID"
                return 0
              fi
              attempt=$((attempt+1))
              echo "GetResources attempt $attempt failed (exit=$EXIT id='$ID'), retrying in ${delay}s..." >&2
              sleep $delay
              delay=$((delay * 2))
            done
            echo "ERROR: Could not fetch resource ID after $max attempts" >&2
            return 1
          }

          if [ "$FN" == "cc-auth-verify-otp" ] || [ "$FN" == "cc-auth-google" ]; then
            ID=$(fetch_resource_id "items[?path=='/auth'].id")
            echo "EXTRA_PARAMS=ApiGatewayAuthResourceId=${ID}" >> $GITHUB_ENV

          elif [ "$FN" == "cc-user-update-profile" ]; then
            ID=$(fetch_resource_id "items[?path=='/user/profile'].id")
            echo "EXTRA_PARAMS=ApiGatewayUserProfileResourceId=${ID}" >> $GITHUB_ENV

          elif [ "$FN" == "cc-payment-verify" ]; then
            ID=$(fetch_resource_id "items[?path=='/payment'].id")
            echo "EXTRA_PARAMS=ApiGatewayPaymentResourceId=${ID}" >> $GITHUB_ENV

          elif [ "$FN" == "cc-report-get" ]; then
            ID=$(fetch_resource_id "items[?path=='/report'].id")
            echo "EXTRA_PARAMS=ApiGatewayReportResourceId=${ID}" >> $GITHUB_ENV

          else
            echo "EXTRA_PARAMS=" >> $GITHUB_ENV
          fi

      - name: Clear failed CloudFormation stack
        run: |
          STACK="cc-${{ matrix.function }}-stack"
          REGION=${{ github.ref == 'refs/heads/main' && 'ap-south-1' || 'eu-west-1' }}
          STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK" \
            --region "$REGION" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")
          echo "Stack status: $STATUS"
          if [ "$STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STATUS" = "CREATE_FAILED" ] || [ "$STATUS" = "ROLLBACK_FAILED" ]; then
            echo "Deleting stuck stack $STACK..."
            aws cloudformation delete-stack --stack-name "$STACK" --region "$REGION"
            aws cloudformation wait stack-delete-complete --stack-name "$STACK" --region "$REGION"
            echo "Stack deleted. Proceeding with fresh deploy."
          fi

      - name: Deploy CloudFormation stack
        run: |
          attempt=0
          max_attempts=3
          delay=15
          until [ "$attempt" -ge "$max_attempts" ]
          do
            echo "Attempt $((attempt+1))..."
            aws cloudformation deploy \
              --template-file src/functions/${{ matrix.function }}/cloudformation/lambda-setup.yml \
              --stack-name cc-${{ matrix.function }}-stack \
              --parameter-overrides \
                StageName=${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }} \
                Env=${{ github.ref == 'refs/heads/main' && 'Production' || 'Development' }} \
                ApiGatewayRestApiId=${{ github.ref == 'refs/heads/main' && 'PROD_API_ID' || 'ykq0pkeh54' }} \
                ApiGatewayRootResourceId=${{ github.ref == 'refs/heads/main' && 'PROD_ROOT_RESOURCE_ID' || 'zxmxqud0of' }} \
                BucketName=${{ github.ref == 'refs/heads/main' && 'chillcareer-zips-ap-south-1' || 'chillcareer-zips-eu-west-1' }} \
                DynamoDBTableSuffix=${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }} \
                $EXTRA_PARAMS \
              --capabilities CAPABILITY_NAMED_IAM && break
            attempt=$((attempt+1))
            echo "Retrying in ${delay}s..."
            sleep $delay
            delay=$((delay * 2))
          done
          if [ "$attempt" -eq "$max_attempts" ]; then
            echo "Deployment failed."
            exit 1
          fi

      - name: Wait for resources
        run: sleep 30

      - name: Update Lambda code
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            BUCKET="chillcareer-zips-ap-south-1"
            REGION="ap-south-1"
          else
            BUCKET="chillcareer-zips-eu-west-1"
            REGION="eu-west-1"
          fi
          aws lambda update-function-code \
            --function-name ${{ matrix.function }}-${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }} \
            --s3-bucket $BUCKET \
            --s3-key ${{ matrix.function }}/function.zip \
            --region $REGION

  # ── Phase 3: Deploy API Gateway stage ─────────────────────────────────────
  deploy-api:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-primary, deploy-secondary]
    if: |
      always() &&
      (needs.deploy-primary.result == 'success' || needs.deploy-secondary.result == 'success')
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::134375574022:role/GitHubActionsDeploymentRole-chillcareer
          role-session-name: GitHubActionsSession
          aws-region: ${{ github.ref == 'refs/heads/main' && 'ap-south-1' || 'eu-west-1' }}

      - name: Deploy API Gateway stage
        run: |
          aws apigateway create-deployment \
            --rest-api-id ${{ github.ref == 'refs/heads/main' && 'PROD_API_ID' || 'ykq0pkeh54' }} \
            --stage-name ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }} \
            --region ${{ github.ref == 'refs/heads/main' && 'ap-south-1' || 'eu-west-1' }}
